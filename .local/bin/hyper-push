#!/usr/bin/env fish
# Safe hypr-dots Sync Script

# Check for uncommitted changes first
set -l status_output (git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME status --porcelain)

if test -z "$status_output"
    notify-send "Rice Sync" "No changes to push"
    exit 0
end

# Show what will be committed
echo "Changes detected:"
git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME status --short

# Add only modified tracked files (never -f)
set -l modified_files (git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME diff --name-only)
if test -n "$modified_files"
    for file in $modified_files
        git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME add $file
        echo "Staged: $file"
    end
end

# Commit
if git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME commit -m "Rice Sync Update - $(date +%Y-%m-%d)"
    echo "Committed successfully"
else
    notify-send "Rice Sync" "Nothing to commit"
    exit 0
end

# Pull with rebase
if not git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME pull --rebase origin main
    notify-send "Rice Sync" "Pull failed - resolve conflicts"
    exit 1
end

# Push
if git --git-dir=$HOME/hypr-dots/ --work-tree=$HOME push origin main
    notify-send "Rice Sync" "Backup successful âœ“"
    echo "Pushed to GitHub successfully"
else
    notify-send "Rice Sync" "Push failed - check terminal"
    exit 1
end
